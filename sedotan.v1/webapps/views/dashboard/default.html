<h1>Dashboard</h1>
<br />
<script type="text/javascript">
var Config = {
    isHistory: ko.observable(false),
    isSnapShot: ko.observable(true)
}
</script>
<div data-bind="with:Config">
    <div class="row">
        <div class="col-md-12">
            <div data-bind="visible:isSnapShot()" id="grid"></div>
        </div>
    </div>
    <div class="row">
        <div data-bind="visible:isHistory()">
            <div class="col-md-12">
                <button class="btn btn-primary" data-bind="click:GoBack"><span class="glyphicon glyphicon-chevron-left"></span> Go Back</button>
            </div>
            <br />
            <div class="col-md-12">
                <div id="grid-history"></div>
            </div>
        </div>
    </div>
</div>

<div id="details"></div>
<style>
.critical {
    background-color: #c9302c;
    font-weight: bold;
    color: #fff;
    text-align: center;
}

.stop {
    background-color: #f0ad4e;
    font-weight: bold;
    color: #fff;
    text-align: center;
}

.ok {
    background-color: #5cb85c;
    font-weight: bold;
    color: #fff;
    text-align: center;
}
</style>
<script id="command-template" type="text/x-kendo-template">
    <a class="k-button k-grid-start btn btn-info" id='service-#:data.nameid#'>
        #= data.status == "STOP" ? "Start" : "Stop" #
    </a>
</script>

<!-- <script type="text/x-kendo-template" id="detail-template">
    <div id="details-container">
        <input id="datePick-#:data.nameid#" style="width: 100%;" />
    </div>
</script> -->

<script>
model.PageId("Dashboard");

$(document).ready(function () {

});

// var wnd, detailsTemplate;
var localdata = {}
$.ajax({
    url: "{{BaseUrl}}dashboard/griddashboard",
    dataType: "json",
    type: "POST",
    async: false,
    success: function(data) {

        var datas = []
        $.each(data, function(i, v) {
            var dataPush = {}
            dataPush.nameid = v.nameid
            dataPush.grabinterval = v.grabinterval + " " + v.intervaltype
            dataPush.url = v.url
            dataPush.status = "STOP";
            dataPush.lastGrab = "";
            dataPush.nextGrab = "";
            dataPush.grabStat = "";

            checkStat(v.nameid, v.grabinterval, 0, i)
            datas.push(dataPush)
        });
        localdata = datas
        // Config.Data(datas)
    },
    error: function(e) {
        console.log(e)
    }
});

var localDataSources = new kendo.data.DataSource({
    data: localdata,
    pageSize: 10
});

//Grid
var commonSettings = {
    dataSource: localDataSources,
    sortable: true,
    pageable: {/* refresh: true, */pageSizes: true,buttonCount: 5},
    columns: [
    {template: kendo.template($("#command-template").html()),width: 80}, 
    {field: "status",title: "STATUS",width: 60}, 
    {field: "nameid",title: "NAME ID",width: 100}, 
    {field: "url",title: "SOURCE",}, 
    {field: "grabinterval",title: "INTERVAL",width: 85}, 
    {field: "lastGrab",title: "LAST GRAB",width: 120}, 
    {field: "nextGrab",title: "NEXT GRAB",width: 120}, 
    {field: "grabStat",title: "GRAB STAT",width: 70}, 
    {field: "note",title: "NOTE"}, 
    {field: "history",title: "History",width:80,attributes:{ class:"align-center" },template:"<button class='btn btn-default' onclick='Config.History(\"#:nameid#\")'><span>History</span></button>"}
    ]
}

function getStatusClass(stat) {
    if (stat == "RUN") {
        return "ok"
    } else if (stat == "STOP") {
        return "stop"
    } else if (stat == "ERROR") {
        return "critical"
    }
}

$("#grid").kendoGrid($.extend({
    dataBound: function(e) {
        var columns = e.sender.columns;
        var columnIndex = 0;
        for (var j = 0; j < columns.length; j++) {
            if (columns[j].field == "status") {
                break;
            }
            columnIndex++;
        }

        var dataItems = e.sender.dataSource.view();
        for (var j = 0; j < dataItems.length; j++) {
            var stat = dataItems[j].get("status");
            var row = e.sender.tbody.find("[data-uid='" + dataItems[j].uid + "']");
            var cell = row.children().eq(columnIndex);
            cell.addClass(getStatusClass(stat));
        }
    }
}, commonSettings));
localDataSources.read()

var grid = $("#grid").data("kendoGrid");
var gridDataSource = grid.dataSource
/*
wnd = $("#details")
    .kendoWindow({
        title: "Please choose date",
        modal: true,
        visible: false,
        resizable: false,
        width: 250
    }).data("kendoWindow").center();

detailsTemplate = kendo.template($("#detail-template").html());

function showDetails(e) {
    e.preventDefault();
    var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
    wnd.content(detailsTemplate(dataItem));
    wnd.center().open();
    
    $("#datePick-" + dataItem.nameid).kendoDatePicker({
        // value:new Date(),
        format: "yyyy/MM/dd",
        max: new Date(new Date()),
        change: onChange
    });
}

function onChange(e) {
    e.preventDefault();
    var dateString = kendo.toString(this.value(), 'd');
    // var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
    console.log(e.View)
    var obj = new Object();
    obj.date = dateString;

    // $.ajax({
    //     url: "{{BaseUrl}}dashboard/getlog",
    //     dataType: "json",
    //     type: "POST",
    //     data: JSON.stringify(obj),
    //     success: function(data) {
    //         console.log(data);
    //     },
    //     error: function(e) {
    //         console.log(e);
    //     }
    // });
    // alert("Change :: " + kendo.toString(this.value(), 'd'));
}
*/
function startService(nameid, uid) {
    var obj = new Object();
    obj.NameId = nameid;
    $.ajax({
        url: "{{BaseUrl}}dashboard/startservice",
        dataType: "json",
        type: "POST",
        data: JSON.stringify(obj),
        success: function(data) {
            console.log(data);
        },
        error: function(e) {
            console.log(e);
        }
    });
}

$("#grid").on("click", ".k-grid-start", function(e) {
    var curBtn = $(e.target);
    var tr = $(e.target).closest("tr"); // get the current table row (tr)
    var data = grid.dataItem(tr);
    var selected = data.status;

    if (selected == "STOP" || selected == undefined) {
        data.set("status", "RUN");
        curBtn.text('Stop');
        startService(data.nameid, data.uid)

        // var currentRow = grid.table.find("tr[data-uid='" + data.uid + "']");
        // var startButton = $(currentRow).find(".k-grid-start");
        // startButton.removeClass("btn-success")
        // startButton.addClass("btn-danger");
    } else {
        data.set("status", "STOP");
        curBtn.text('Start');
        stopService(data.nameid, data.uid)
            // var currenRow = grid.table.find("tr[data-uid='" + data.uid + "']");
            // var startButton = $(currenRow).find(".k-grid-start");
            // startButton.removeClass("btn-danger")
            // startButton.addClass("btn-success");
    }
});


function stopService(nameid, uid) {
    var obj = new Object();
    obj.NameId = nameid;
    $.ajax({
        url: "{{BaseUrl}}dashboard/stopservice",
        dataType: "json",
        type: "POST",
        data: JSON.stringify(obj),
        success: function(data) {
            console.log(data)
        },
        error: function(e) {
            console.log(e);
        }
    });
}


$.each(grid.dataSource.data(), function(key, val) {
    var inSecond = 50000 //every 5 minutes
    var myInterval = setInterval(function() {
        checkStat(val.nameid, val.grabinterval, val.uid, key)
    }, inSecond)
});

function checkStat(nameid, interval, uid, index) {
    var obj = new Object()
    obj.NameId = nameid
    $.ajax({
        url: "{{BaseUrl}}dashboard/stat",
        dataType: "json",
        type: "POST",
        data: JSON.stringify(obj),
        success: function(data) {
            if (!data.grabStat && data.errorNote != "") {
                var dataGrid = gridDataSource.at(index);
                errorStatus(data, dataGrid)
            } else if (data.name == nameid) {
                if (data.isRun) {
                    var dataGrid = gridDataSource.at(index);
                    runStatus(data, dataGrid, uid)
                } else {
                    var dataGrid = gridDataSource.at(index);
                    stopStatus(data, dataGrid, uid)
                }
            }
        },
        error: function(e) {
            console.log(e)
        }
    });
}

function runStatus(data, dataGrid, uid) {
    dataGrid.set("lastGrab", data.lastDate)
    dataGrid.set("nextGrab", data.nextDate)
    dataGrid.set("grabStat", data.grabStat)
    dataGrid.set("note", data.errorNote)
    dataGrid.set("status", "RUN");
}

function stopStatus(data, dataGrid, uid) {
    dataGrid.set("lastGrab", data.lastDate)
    dataGrid.set("nextGrab", data.nextDate)
    dataGrid.set("grabStat", data.grabStat)
    dataGrid.set("note", data.errorNote)
    dataGrid.set("status", "STOP");
}

function errorStatus(data, dataGrid) {
    dataGrid.set("grabStat", data.grabStat)
    dataGrid.set("note", errorNote)
    dataGrid.set("status", "ERROR");
}

Config.History = function(nameid){
    Config.isHistory(true);
    Config.isSnapShot(false)

    var obj = new Object();
    obj.NameId = nameid
    // $.ajax({
    //     url: "{{BaseUrl}}dashboard/gethistory",
    //     dataType: "json",
    //     type: "POST",
    //     data: JSON.stringify(obj),
    //     success: function(data) {
    //         Config.Data(data);
    //         console.log(data);
    //     },
    //     error: function(e) {
    //         console.log(e);
    //     }
    // });
    // var dataSource = Config.Data();
    $("#grid-history").kendoGrid({
        dataSource:{
            data: localdata,
            pageSize: 10
        },
        sortable: true,
        pageable: {/* refresh: true, */pageSizes: true,buttonCount: 5},
        columns: [
        {field: "id",title: "ID"}, 
        {field: "startexecute",title: "START"}, 
        {field: "status",title: "STATUS"}, 
        {field: "grabcount",title: "GRAB COUNT",width: 85},
        {field: "logBtn",title: "&nbsp;",width:80,attributes:{ class:"align-center" },template:"<button class='btn btn-default' onclick='Config.Log(\"#:nameid#\")'><span>Log</span></button>"}
        ]
    });
}

Config.GoBack = function(){
        Config.isHistory(false);
        Config.isSnapShot(true);
    }
</script>
