<h1>Dashboard</h1>

<div id="grid">
</div>

<div  data-bind="with:Dashboard">
	<div class="row">
	     <div class="col-md-12">
	     Dashboard Page
	     </div>
	</div>

	<div class="row">
	     <div class="col-md-4">
	     Cok jenengmu sopo
	     </div>
	     <div class="col-md-8">
	     <input type="text" data-bind="value:Jenengku"/>
	     </div>
	</div>

	<div class="row">
	     <div class="col-md-12">
	     Nek jenengku <span data-bind="text:Jenengku"></span> kon kate lapo
	     </div>
	</div>
</div>
<style>
.critical {
    background-color: #d9534f;
    font-weight: bold;
    color: #fff;
}

.stop {
    background-color: #777;
    font-weight: bold;
    color: #fff;
}

.ok {
    background-color: #5cb85c;
    font-weight: bold;
    color: #fff;
}
</style>

<script>
var localdata = {}
$.ajax({
    url: "{{BaseUrl}}dashboard/griddashboard",
    dataType: "json",
    type: "POST",
    async: false,
    success: function(data) {
        
        var datas = []
        $.each(data, function(i,v){
            var dataPush = {}
            $.each(v, function(j,x){
                dataPush[j] = x;
                dataPush.status = "STOP";
                dataPush.lastGrab = "";
                dataPush.grabStat = "";
            })
            checkStat(v.nameid, v.grabinterval, 0, i)
            datas.push(dataPush)
        });
        localdata = datas        
    },
    error: function(e) {
        console.log(e)
    }
});

var localDataSources = new kendo.data.DataSource({
    data: localdata
});

//Grid
var commonSettings = {
	dataSource: localDataSources,
    height: 550,
    sortable: true,
    pageable: {
        refresh: true,
        pageSizes: true,
        buttonCount: 5
    },
    editable: false,
	columns: [{
        field: "status",
        title: "STATUS",
        width: 100
    }, {
        field: "nameid",
        title: "NAME ID"
    }, {
        field: "url",
        title: "SOURCE"
    }, {
        field: "grabinterval",
        title: "INTERVAL"
    }, {
        field: "lastGrab",
        title: "LAST GRAB"
    }, {
        field: "grabStat",
        title: "GRAB STAT"
    }, {
        field: "note",
        title: "NOTE"
    }, {
    	command:[
        {
            text: "Start",
            name: "start",
            className: "btn btn-success",
            click: startService
        }, 
        {
            text:"Stop",
            name: "stop",
            className: "btn btn-default",
            click: stopService
        }
        ], width: "165px"
    }]
}

function getStatusClass(stat){
    if (stat == "RUN") {
        return "ok"
    } else if (stat =="STOP") {
        return "stop"
    } else if (stat == "ERROR") {
        return "critical"
    }
}

$("#grid").kendoGrid($.extend({
        dataBound: function(e) {
            var columns = e.sender.columns;
            var columnIndex = 0;
            for (var j = 0; j < columns.length; j++) {
                if (columns[j].field == "status") {
                    break;
                }
                columnIndex++;
            }
            
            var dataItems = e.sender.dataSource.view();
            for (var j = 0; j < dataItems.length; j++) {
                
                var stat = dataItems[j].get("status");
                var row = e.sender.tbody.find("[data-uid='" + dataItems[j].uid + "']");
                var cell = row.children().eq(columnIndex);                
                cell.addClass(getStatusClass(stat));
            }
        }
    }, commonSettings));


var grid = $("#grid").data("kendoGrid");
function startService(e) {
    e.preventDefault();
    var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
    console.log(dataItem);
    var obj = new Object();
    obj.NameId = dataItem.nameid;
    $.ajax({
            url: "{{BaseUrl}}dashboard/startservice",
            dataType: "json",
            type: "POST",
            data: JSON.stringify(obj),
            success: function(data) {
                
                if (data){
                    // var grid = $("#grid").data("kendoGrid");
                    var index
                    $.each(grid.dataSource.data(), function(key, val){
                        if (val.nameid == dataItem.nameid){
                            index = key
                        }                    
                    });

                    // var grid = $("#grid").data("kendoGrid");
                    var dataGrid = grid.dataSource.at(index);
                    dataGrid.set("status","RUN");
                    
                    var currenRow = grid.table.find("tr[data-uid='" + dataGrid.uid + "']");
                    var startButton = $(currenRow).find(".k-grid-start");
                    startButton.removeClass("btn-success")
                    startButton.addClass("btn-default");

                    var stopButton = $(currenRow).find(".k-grid-stop");
                    stopButton.removeClass("btn-default")
                    stopButton.addClass("btn-danger");

                    // checkStat(dataItem.nameid, dataItem.grabinterval, dataItem.uid, index, "start");
                }
                
            },
            error: function(e) {
                console.log(e);
            }
        });
}


function stopService(e){
    e.preventDefault();
    var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
    var obj = new Object();
    obj.NameId = dataItem.nameid;
    $.ajax({
        url: "{{BaseUrl}}dashboard/stopservice",
        dataType: "json",
        type: "POST",
        data: JSON.stringify(obj),
        success: function(data) {
            console.log(data);
            if (data.name == dataItem.nameid && !data.stat){
                // var grid = $("#grid").data("kendoGrid");
                var index
                $.each(grid.dataSource.data(), function(key, val){
                    if (val.nameid == dataItem.nameid){
                        index = key
                    }                    
                });

                // var grid = $("#grid").data("kendoGrid");
                var dataGrid = grid.dataSource.at(index);
                dataGrid.set("status","STOP");
                
                var currenRow = grid.table.find("tr[data-uid='" + dataGrid.uid + "']");
                var startButton = $(currenRow).find(".k-grid-start");
                startButton.removeClass("btn-default")
                startButton.addClass("btn-success");

                var stopButton = $(currenRow).find(".k-grid-stop");
                stopButton.removeClass("btn-danger")
                stopButton.addClass("btn-default");
                // checkStat(dataItem.nameid, dataItem.grabinterval, dataItem.uid);
            }
            
        },
        error: function(e) {
            console.log(e);
        }
    });
}


$.each(grid.dataSource.data(), function(key, val){
    var inSecond = val.grabinterval * 1000
    var myInterval = setInterval(function () {checkStat(val.nameid, val.grabinterval, val.uid, key)}, inSecond)
});

function checkStat(nameid, interval, uid, index){
    var inSecond = interval * 1000
    var obj = new Object()
    obj.NameId = nameid
    $.ajax({
        url: "{{BaseUrl}}dashboard/stat",
        dataType: "json",
        type: "POST",
        data: JSON.stringify(obj),
        success: function(data) {    
        console.log(data)        
            var dataGrid = grid.dataSource.at(index);
            var dateNow = (typeof data.dateNow === "undefined")? "" : data.dateNow;
            var timeNow = (typeof data.timeNow === "undefined")? "" : data.timeNow;
            dataGrid.set("lastGrab", dateNow+" "+timeNow)
            dataGrid.set("grabStat", data.status)
            dataGrid.set("note", data.note)
            if (data.name == nameid && data.isRun) {
                dataGrid.set("status","RUN");
                
                uid = (uid == 0)? dataGrid.uid : uid
                var currenRow = grid.table.find("tr[data-uid='" + uid + "']");
                var startButton = $(currenRow).find(".k-grid-start");
                startButton.removeClass("btn-success")
                startButton.addClass("btn-default");

                var stopButton = $(currenRow).find(".k-grid-stop");
                stopButton.removeClass("btn-default")
                stopButton.addClass("btn-danger");
            } else {
                dataGrid.set("status","STOP");
                
                uid = (uid == 0)? dataGrid.uid : uid
                var currenRow = grid.table.find("tr[data-uid='" + uid + "']");
                var startButton = $(currenRow).find(".k-grid-start");
                startButton.removeClass("btn-default")
                startButton.addClass("btn-success");

                var stopButton = $(currenRow).find(".k-grid-stop");
                stopButton.removeClass("btn-danger")
                stopButton.addClass("btn-default");
            }
        },
        error: function(e) {
            console.log(e)
        }
    });
}

function getConfig() {
    //get config
    $.ajax({
        url: "{{BaseUrl}}dashboard/getconfig",
        dataType: "json",
        type: "POST",
        success: function(data){
        console.log(data)
        // options.success(data)
        }
    });
}
var Dashboard = {
	Jenengku:ko.observable("Ainur")
}
</script>